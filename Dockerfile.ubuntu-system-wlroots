# HyprMoon using Ubuntu's system wlroots approach (matching working packaged version)
FROM ubuntu:25.04

# Install exact dependencies from Ubuntu's control file
RUN apt-get update && apt-get install -y \
    # Build dependencies from Ubuntu's control file
    chrpath cmake cpio debhelper-compat hwdata \
    hyprland-protocols hyprwayland-scanner \
    libcairo-dev libdrm-dev libxkbcommon-dev \
    libegl-dev libegl1-mesa-dev libgles-dev \
    libhyprlang-dev libhyprcursor-dev libhyprutils-dev \
    libinput-dev libpango1.0-dev libpixman-1-dev \
    libseat-dev libtomlplusplus-dev libudev-dev \
    libudis86-dev libwayland-dev libwlroots-0.18-dev \
    libxcb-errors-dev libxcb-util-dev meson ninja-build \
    pkgconf wayland-protocols xwayland \
    # Runtime dependencies from Ubuntu package
    polkitd binutils libgl1-mesa-dri \
    # Additional tools
    git build-essential \
    # Moonlight dependencies
    libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
    libgstreamer-plugins-bad1.0-dev gstreamer1.0-plugins-base \
    gstreamer1.0-plugins-good gstreamer1.0-plugins-bad \
    gstreamer1.0-plugins-ugly gstreamer1.0-libav \
    gstreamer1.0-tools libgstreamer-gl1.0-0 \
    libenet-dev libssl-dev libfmt-dev \
    libboost-system-dev libboost-filesystem-dev \
    libboost-locale-dev libboost-thread-dev \
    libpci-dev libcurl4-openssl-dev \
    libnice-dev libjsoncpp-dev \
    # VNC and GPU support (exactly like helix)
    wayvnc cage sway-backgrounds weston \
    bc coreutils cmake curl rsync wget ripgrep jq meson xdg-user-dirs unzip \
    fontconfig eza fish kitty \
    glib2.0-bin wl-clipboard translate-shell \
    pipewire-audio pulseaudio-utils alsa-utils \
    libpulse-dev \
    python3 python3-pip python3-venv \
    nodejs npm python3 python3-pip \
    # Intel/Mesa GPU drivers (exactly like helix)
    va-driver-all intel-media-va-driver-non-free \
    libva-drm2 libva-x11-2 libvpl2 \
    # Core Mesa/OpenGL libraries for GPU acceleration (exactly like helix)
    mesa-utils mesa-utils-extra \
    libgl1-mesa-dri libglx-mesa0 \
    libegl-mesa0 libgles2-mesa-dev \
    libgbm1 libdrm2 \
    # Hardware detection tools and kernel module support (exactly like helix)
    pciutils lshw usbutils kmod libkmod2 \
    # Wayland display protocol libraries (exactly like helix)
    libwayland-dev libwayland-server0 libinput-dev libxkbcommon-dev \
    # Runtime dependencies (exactly like helix)
    libfontconfig1 libfreetype6 libxcb1 libxcb-render0 libxcb-shape0 \
    libxcb-xfixes0 libxcb-shm0 libxkbcommon0 libxkbcommon-x11-0 \
    libasound2t64 libssl3 libgtk-3-0 libgdk-pixbuf2.0-0 libpango-1.0-0 libcairo2 \
    # DBus and session management (exactly like helix)
    dbus-x11 dbus \
    # XWayland for X11 app compatibility (exactly like helix)
    xwayland \
    # Additional tools (exactly like helix)
    supervisor nano vim \
    && rm -rf /var/lib/apt/lists/*

# Add NVIDIA CUDA runtime libraries for GPU acceleration (exactly like helix)
RUN apt-get update -y && \
    apt-get install -y unzip curl && \
    cd /tmp && \
    curl -fsSL -o nvidia_cuda_nvrtc_linux_x86_64.whl "https://developer.download.nvidia.com/compute/redist/nvidia-cuda-nvrtc/nvidia_cuda_nvrtc-11.0.221-cp36-cp36m-linux_x86_64.whl" && \
    unzip -joq -d ./nvrtc nvidia_cuda_nvrtc_linux_x86_64.whl && \
    cd nvrtc && \
    chmod 755 libnvrtc* && \
    find . -maxdepth 1 -type f -name "*libnvrtc.so.*" -exec sh -c 'ln -snf $(basename {}) libnvrtc.so' \; && \
    mkdir -p /usr/local/nvidia/lib && \
    mv -f libnvrtc* /usr/local/nvidia/lib && \
    rm -rf /tmp/* && \
    echo "/usr/local/nvidia/lib" >> /etc/ld.so.conf.d/nvidia.conf && \
    echo "/usr/local/nvidia/lib64" >> /etc/ld.so.conf.d/nvidia.conf && \
    ldconfig && \
    apt-get remove -y --purge unzip curl && \
    rm -rf /var/lib/apt/lists/*

# Configure ubuntu user for Wayland sessions (exactly like helix) 
RUN echo 'ubuntu:helix123' | chpasswd && usermod -aG sudo ubuntu && \
    groupadd -f -g 992 render && usermod -aG video,render ubuntu

# Copy our moonlight-integrated Hyprland source
COPY . /workspace/hyprmoon
WORKDIR /workspace/hyprmoon

# Build HyprMoon with system dependencies (Ubuntu-style) with build cache
RUN --mount=type=cache,target=/workspace/hyprmoon/build \
    echo "Building HyprMoon with system wlroots..." && \
    # Override warning flags to not treat warnings as errors
    export CXXFLAGS="-Wno-error" && \
    export CFLAGS="-Wno-error" && \
    # Build with system dependencies
    meson setup build --prefix=/usr/local --buildtype=debugoptimized \
        --default-library=shared \
        -Dwith_moonlight=true --reconfigure && \
    ninja -C build && \
    ninja -C build install && \
    echo "HyprMoon with system wlroots built successfully"

# Copy helix's proven startup scripts
COPY start-wayland-vnc.sh /start-wayland-vnc.sh
COPY start-ubuntu-session-test.sh /start-ubuntu-session-system.sh
RUN chmod +x /start-wayland-vnc.sh /start-ubuntu-session-system.sh

# Use our custom HyprMoon binary instead of Ubuntu's
RUN sed -i 's|/usr/bin/Hyprland --config /test_config/hyprland.conf|/usr/local/bin/Hyprland --config /test_config/hyprland.conf|g' /start-ubuntu-session-system.sh

# Copy test config
COPY test_hyprland.conf /test_config/hyprland.conf

# Environment variables for Wayland (exactly like helix)
ENV WAYLAND_DISPLAY=wayland-0 \
    XDG_RUNTIME_DIR=/tmp/runtime-ubuntu \
    WLR_RENDERER=gles2 \
    WLR_BACKENDS=headless \
    VNC_PASSWORD=helix123

# Expose VNC port and moonlight ports
EXPOSE 5901 3030
EXPOSE 48989/tcp 49010/tcp 48999/tcp

# Start Wayland VNC (exactly like helix)
ENTRYPOINT ["/start-wayland-vnc.sh"]