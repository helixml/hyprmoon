#!/usr/bin/make -f
# export DH_VERBOSE = 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DEB_CFLAGS_MAINT_APPEND  = -w -Wno-unused -Wno-deprecated -Wno-deprecated-declarations
export DEB_CXXFLAGS_MAINT_APPEND = -w -Wno-unused -Wno-deprecated -Wno-deprecated-declarations
export DEB_LDFLAGS_MAINT_APPEND = -Wl,-O2

# Step 8.6: Re-enable ccache and ninja for better builds
# export CCACHE_DISABLE = 1
# export CC = gcc
# export CXX = g++

%:
	dh $@

override_dh_auto_build:
	@echo "=== NINJA BUILD STATS BEFORE ==="
	@if [ -d build ]; then \
		cd build && ninja -t targets all | wc -l | xargs echo "Total targets:"; \
		cd build && find . -name "*.ninja*" 2>/dev/null | wc -l | xargs echo "Ninja cache files:"; \
	else \
		echo "No build directory - clean build"; \
	fi
	dh_auto_build -- PREFIX=/usr all
	@echo "=== NINJA BUILD STATS AFTER ==="
	@if [ -d build ]; then \
		cd build && ninja -t targets all | wc -l | xargs echo "Total targets:"; \
		cd build && find . -name "*.o" 2>/dev/null | wc -l | xargs echo "Object files:"; \
	fi

override_dh_auto_install:
	# Fix permission on hyprland.pc (Hyprland sets 777 on everything in
	# build/ directory)
	chmod 644 build/hyprland.pc

	# dh_auto_install auto detects the correct DESTDIR.
	# Modify PREFIX so that this DESTDIR is actually taken into account.
	# (Upstream Makefile supports PREFIX, but not DESTDIR)
	dh_auto_install -- PREFIX='$${DESTDIR}/usr'

override_dh_clean:
	# Always clean up auxiliary directories that can cause issues
	rm -rf subprojects/wlroots-hyprland/src/wlroots-hyprland-stamp
	rm -f subprojects/udis86/libudis86/itab*
	rm -rf subprojects/wlroots-hyprland/tmp

	# Reverse the patches in subprojects/wlroots-hyprland
	cd subprojects/wlroots-hyprland ; \
		patches=$$(find patches/ -type f -name '*.patch') ; \
		echo $$patches ; \
		for PATCH in $$patches ; do \
		    patch -p1 -r /dev/null -N --dry-run -s < $$PATCH  || patch -p1 -r /dev/null -R -s < $$PATCH ; \
		done ;

	# Step 8.6: Allow incremental builds with ccache and ninja
	dh_clean -X scripts/generateVersion.sh.bak -X build/
	@echo "Incremental build with ccache and ninja enabled"

override_dh_dwz:
	dh_dwz -XHyprland # Skipping dwz, compression not beneficial on Hyprland

#override_dh_auto_configure:
#	dh_auto_configure -- \
#	      -DCMAKE_LIBRARY_ARCHITECTURE="$(DEB_TARGET_MULTIARCH)"
