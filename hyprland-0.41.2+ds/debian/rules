#!/usr/bin/make -f
# export DH_VERBOSE = 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DEB_CFLAGS_MAINT_APPEND  = -w -Wno-unused -Wno-deprecated -Wno-deprecated-declarations
export DEB_CXXFLAGS_MAINT_APPEND = -w -Wno-unused -Wno-deprecated -Wno-deprecated-declarations
export DEB_LDFLAGS_MAINT_APPEND = -Wl,-O2

# Step 8.6: Re-enable ccache and ninja for better builds
# export CCACHE_DISABLE = 1
# export CC = gcc
# export CXX = g++

%:
	dh $@

override_dh_auto_build:
	@echo "=== NINJA BUILD DEBUGGING ==="
	@{ \
		echo "ðŸ¥· Ninja Build Debug Report - $(date)"; \
		if [ -d build ] && [ -f build/.ninja_log ]; then echo "ðŸš€ Build Type: INCREMENTAL (skip configure)"; else echo "ðŸš€ Build Type: FULL (with configure)"; fi; \
		echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
		if [ -d build ]; then \
			cd build; \
			echo "ðŸ“Š BEFORE BUILD:"; \
			ninja -t targets all | wc -l | xargs echo "  Total targets:"; \
			find . -name "*.ninja*" 2>/dev/null | wc -l | xargs echo "  Ninja cache files:"; \
			ls -la .ninja_deps .ninja_log 2>/dev/null | head -2 || echo "  No ninja dependency files"; \
			echo ""; \
			echo "ðŸ” WHY REBUILDING (ninja explain):"; \
			ninja -n -d explain 2>&1 | head -15 | sed 's/^/  /' || echo "  No ninja explain available"; \
		else \
			echo "ðŸ“ No build directory - clean build"; \
		fi; \
		echo ""; \
	} > /workspace/ninja-debug.log
	@if [ -d build ] && [ -f build/.ninja_log ] && [ -f build/build.ninja ]; then \
		echo "ðŸš€ INCREMENTAL BUILD: Skipping configure, going straight to ninja"; \
		cd build && ninja; \
	else \
		echo "ðŸ”§ FULL BUILD: Running configure + build"; \
		dh_auto_build -- PREFIX=/usr all; \
	fi
	@{ \
		echo "ðŸ“Š AFTER BUILD:"; \
		if [ -d build ]; then \
			cd build; \
			ninja -t targets all | wc -l | xargs echo "  Total targets:"; \
			find . -name "*.o" 2>/dev/null | wc -l | xargs echo "  Object files generated:"; \
			echo ""; \
			echo "ðŸ”¨ LAST 10 TARGETS BUILT:"; \
			tail -10 .ninja_log 2>/dev/null | cut -f4 | sed 's/^/  /' || echo "  No ninja log available"; \
		fi; \
		echo ""; \
		echo "âœ… Debug report complete - $(date)"; \
		echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"; \
	} >> /workspace/ninja-debug.log

override_dh_auto_install:
	# Fix permission on hyprland.pc (Hyprland sets 777 on everything in
	# build/ directory)
	# Fix permission on hyprland.pc if it exists (incremental builds may skip this)
	[ -f build/hyprland.pc ] && chmod 644 build/hyprland.pc || true

	# dh_auto_install auto detects the correct DESTDIR.
	# Modify PREFIX so that this DESTDIR is actually taken into account.
	# (Upstream Makefile supports PREFIX, but not DESTDIR)
	dh_auto_install -- PREFIX='$${DESTDIR}/usr'

override_dh_clean:
	# Always clean up auxiliary directories that can cause issues
	rm -rf subprojects/wlroots-hyprland/src/wlroots-hyprland-stamp
	rm -f subprojects/udis86/libudis86/itab*
	rm -rf subprojects/wlroots-hyprland/tmp

	# Reverse the patches in subprojects/wlroots-hyprland
	cd subprojects/wlroots-hyprland ; \
		patches=$$(find patches/ -type f -name '*.patch') ; \
		echo $$patches ; \
		for PATCH in $$patches ; do \
		    patch -p1 -r /dev/null -N --dry-run -s < $$PATCH  || patch -p1 -r /dev/null -R -s < $$PATCH ; \
		done ;

	# Step 8.6: Allow incremental builds with ccache and ninja
	# Exclude build directory and CMake files to prevent reconfiguration
	dh_clean -X scripts/generateVersion.sh.bak -X build/ -X build/CMakeFiles/ -X build/CMakeCache.txt -X build/cmake_install.cmake -X build/CMakeFiles/VerifyGlobs.cmake_force
	@echo "Incremental build with ccache and ninja enabled"

override_dh_dwz:
	dh_dwz -XHyprland # Skipping dwz, compression not beneficial on Hyprland

#override_dh_auto_configure:
#	dh_auto_configure -- \
#	      -DCMAKE_LIBRARY_ARCHITECTURE="$(DEB_TARGET_MULTIARCH)"
